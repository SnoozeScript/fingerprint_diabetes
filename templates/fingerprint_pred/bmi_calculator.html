{% extends 'base.html' %}

{% block title %}BMI Calculator - Health Assessment{% endblock %}

{% block extra_css %}
<style>
.bmi-gauge {
    width: 250px;
    height: 125px;
    position: relative;
    margin: 0 auto;
    overflow: hidden;
}

.bmi-arc {
    width: 250px;
    height: 250px;
    border-radius: 50%;
    position: absolute;
    top: -125px;
    background: conic-gradient(
        #3498db 0deg 36deg,      /* Underweight */
        #2ecc71 36deg 90deg,     /* Normal */
        #f39c12 90deg 126deg,    /* Overweight */
        #e74c3c 126deg 180deg    /* Obese */
    );
}

.bmi-inner {
    width: 200px;
    height: 200px;
    background: white;
    border-radius: 50%;
    position: absolute;
    top: -175px;
    left: 25px;
}

.bmi-needle {
    width: 2px;
    height: 100px;
    background: #2c3e50;
    position: absolute;
    bottom: 0;
    left: 50%;
    transform-origin: bottom center;
    transform: translateX(-50%) rotate(0deg);
    transition: transform 0.5s ease;
    z-index: 10;
}

.bmi-center {
    width: 20px;
    height: 20px;
    background: #2c3e50;
    border-radius: 50%;
    position: absolute;
    bottom: -10px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 11;
}

.bmi-categories {
    display: flex;
    justify-content: space-between;
    margin-top: 20px;
    font-size: 0.8rem;
}

.health-tip {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 15px;
    padding: 20px;
    margin: 20px 0;
}

.calculator-card {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    color: white;
    border-radius: 20px;
}

.result-card {
    border-radius: 15px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
}
</style>
{% endblock %}

{% block content %}
<div class="container my-5">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12 text-center">
            <h2><i class="bi bi-calculator"></i> BMI Calculator</h2>
            <p class="text-muted">Calculate your Body Mass Index and understand your health status</p>
        </div>
    </div>

    <div class="row">
        <!-- Calculator Form -->
        <div class="col-lg-6 mb-4">
            <div class="card calculator-card">
                <div class="card-body">
                    <h4 class="text-center mb-4">
                        <i class="bi bi-person-check"></i> Calculate Your BMI
                    </h4>
                    
                    <form id="bmiForm" method="post">
                        {% csrf_token %}
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="weight" class="form-label">
                                    <i class="bi bi-speedometer2"></i> Weight
                                </label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="weight" name="weight" 
                                           step="0.1" min="1" max="500" required 
                                           value="{{ form.weight.value|default:'' }}">
                                    <select class="form-select" id="weightUnit" style="max-width: 80px;">
                                        <option value="kg">kg</option>
                                        <option value="lbs">lbs</option>
                                    </select>
                                </div>
                                {% if form.weight.errors %}
                                    <div class="text-warning small">{{ form.weight.errors.0 }}</div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="height" class="form-label">
                                    <i class="bi bi-rulers"></i> Height
                                </label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="height" name="height" 
                                           step="0.1" min="1" max="300" required 
                                           value="{{ form.height.value|default:'' }}">
                                    <select class="form-select" id="heightUnit" style="max-width: 80px;">
                                        <option value="cm">cm</option>
                                        <option value="ft">ft</option>
                                    </select>
                                </div>
                                {% if form.height.errors %}
                                    <div class="text-warning small">{{ form.height.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="age" class="form-label">
                                    <i class="bi bi-calendar3"></i> Age
                                </label>
                                <input type="number" class="form-control" id="age" name="age" 
                                       min="1" max="120" required 
                                       value="{{ form.age.value|default:'' }}">
                                {% if form.age.errors %}
                                    <div class="text-warning small">{{ form.age.errors.0 }}</div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="gender" class="form-label">
                                    <i class="bi bi-person"></i> Gender
                                </label>
                                <select class="form-select" id="gender" name="gender" required>
                                    <option value="">Select Gender</option>
                                    <option value="M" {% if form.gender.value == 'M' %}selected{% endif %}>Male</option>
                                    <option value="F" {% if form.gender.value == 'F' %}selected{% endif %}>Female</option>
                                </select>
                                {% if form.gender.errors %}
                                    <div class="text-warning small">{{ form.gender.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="text-center">
                            <button type="submit" class="btn btn-light btn-lg px-5">
                                <i class="bi bi-calculator"></i> Calculate BMI
                            </button>
                        </div>
                    </form>
                    
                    <!-- Quick Calculate Button -->
                    <div class="text-center mt-3">
                        <button type="button" class="btn btn-outline-light" onclick="calculateInstant()">
                            <i class="bi bi-lightning"></i> Quick Calculate
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Display -->
        <div class="col-lg-6 mb-4">
            <div class="card result-card">
                <div class="card-body text-center">
                    <h5 class="card-title">Your BMI Result</h5>
                    
                    <!-- BMI Gauge -->
                    <div class="bmi-gauge">
                        <div class="bmi-arc"></div>
                        <div class="bmi-inner"></div>
                        <div class="bmi-needle" id="bmiNeedle"></div>
                        <div class="bmi-center"></div>
                    </div>
                    
                    <div class="bmi-categories">
                        <span class="text-primary">Underweight</span>
                        <span class="text-success">Normal</span>
                        <span class="text-warning">Overweight</span>
                        <span class="text-danger">Obese</span>
                    </div>
                    
                    <!-- Result Display -->
                    <div id="bmiResult" class="mt-4">
                        {% if bmi %}
                            <h2 class="{% if bmi < 18.5 %}text-primary{% elif bmi < 25 %}text-success{% elif bmi < 30 %}text-warning{% else %}text-danger{% endif %}">
                                {{ bmi|floatformat:1 }}
                            </h2>
                            <h5 class="{% if bmi < 18.5 %}text-primary{% elif bmi < 25 %}text-success{% elif bmi < 30 %}text-warning{% else %}text-danger{% endif %}">
                                {% if bmi < 18.5 %}Underweight
                                {% elif bmi < 25 %}Normal Weight
                                {% elif bmi < 30 %}Overweight
                                {% else %}Obese
                                {% endif %}
                            </h5>
                        {% else %}
                            <h2 class="text-muted">--</h2>
                            <h5 class="text-muted">Enter your details above</h5>
                        {% endif %}
                    </div>
                    
                    <!-- BMI Ranges -->
                    <div class="mt-4">
                        <small class="text-muted">BMI Ranges:</small>
                        <div class="text-start mt-2" style="font-size: 0.9rem;">
                            <div class="d-flex justify-content-between">
                                <span class="text-primary">Underweight:</span>
                                <span>&lt; 18.5</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span class="text-success">Normal:</span>
                                <span>18.5 - 24.9</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span class="text-warning">Overweight:</span>
                                <span>25.0 - 29.9</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span class="text-danger">Obese:</span>
                                <span>&gt;= 30.0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Health Information -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="health-tip">
                <div class="row align-items-center">
                    <div class="col-md-2 text-center">
                        <i class="bi bi-heart-pulse" style="font-size: 3rem;"></i>
                    </div>
                    <div class="col-md-10">
                        <h5>Understanding Your BMI</h5>
                        <p class="mb-2">
                            BMI is a useful screening tool for weight categories that may lead to health problems, 
                            but it's not a diagnostic tool. Factors like muscle mass, bone density, and overall 
                            body composition aren't considered in BMI calculations.
                        </p>
                        <p class="mb-0">
                            <strong>Remember:</strong> Always consult with healthcare professionals for personalized 
                            health advice and assessment.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Health Recommendations -->
    {% if bmi %}
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="bi bi-lightbulb"></i> Health Recommendations</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% if bmi < 18.5 %}
                            <div class="col-md-6">
                                <div class="alert alert-info">
                                    <h6><i class="bi bi-info-circle"></i> For Underweight</h6>
                                    <ul class="mb-0">
                                        <li>Increase caloric intake with nutritious foods</li>
                                        <li>Include healthy fats and proteins</li>
                                        <li>Consider strength training</li>
                                        <li>Consult a nutritionist</li>
                                    </ul>
                                </div>
                            </div>
                        {% elif bmi < 25 %}
                            <div class="col-md-6">
                                <div class="alert alert-success">
                                    <h6><i class="bi bi-check-circle"></i> For Normal Weight</h6>
                                    <ul class="mb-0">
                                        <li>Maintain current healthy habits</li>
                                        <li>Regular physical activity</li>
                                        <li>Balanced diet</li>
                                        <li>Regular health check-ups</li>
                                    </ul>
                                </div>
                            </div>
                        {% elif bmi < 30 %}
                            <div class="col-md-6">
                                <div class="alert alert-warning">
                                    <h6><i class="bi bi-exclamation-triangle"></i> For Overweight</h6>
                                    <ul class="mb-0">
                                        <li>Gradual weight loss (1-2 lbs/week)</li>
                                        <li>Increase physical activity</li>
                                        <li>Reduce portion sizes</li>
                                        <li>Focus on whole foods</li>
                                    </ul>
                                </div>
                            </div>
                        {% else %}
                            <div class="col-md-6">
                                <div class="alert alert-danger">
                                    <h6><i class="bi bi-exclamation-circle"></i> For Obesity</h6>
                                    <ul class="mb-0">
                                        <li>Consult healthcare provider</li>
                                        <li>Create structured weight loss plan</li>
                                        <li>Consider professional support</li>
                                        <li>Focus on sustainable changes</li>
                                    </ul>
                                </div>
                            </div>
                        {% endif %}
                        
                        <div class="col-md-6">
                            <div class="card border-primary">
                                <div class="card-body">
                                    <h6><i class="bi bi-activity"></i> General Tips</h6>
                                    <ul class="mb-0">
                                        <li>Stay hydrated (8+ glasses water/day)</li>
                                        <li>Get adequate sleep (7-9 hours)</li>
                                        <li>Manage stress levels</li>
                                        <li>Avoid processed foods</li>
                                        <li>Regular health monitoring</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Action Buttons -->
    <div class="row mt-4">
        <div class="col-12 text-center">
            <div class="btn-group" role="group">
                <a href="{% url 'fingerprint_pred:upload_fingerprint' %}" class="btn btn-primary btn-lg">
                    <i class="bi bi-upload"></i> Diabetes Assessment
                </a>
                <a href="{% url 'fingerprint_pred:dashboard' %}" class="btn btn-outline-secondary btn-lg">
                    <i class="bi bi-speedometer2"></i> Dashboard
                </a>
                <button class="btn btn-outline-success btn-lg" onclick="saveBMIRecord()">
                    <i class="bi bi-bookmark"></i> Save Result
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Update BMI needle position
function updateBMINeedle(bmi) {
    const needle = document.getElementById('bmiNeedle');
    let angle = 0;
    
    if (bmi < 18.5) {
        // Underweight: 0° to 36°
        angle = (bmi / 18.5) * 36;
    } else if (bmi < 25) {
        // Normal: 36° to 90°
        angle = 36 + ((bmi - 18.5) / (25 - 18.5)) * 54;
    } else if (bmi < 30) {
        // Overweight: 90° to 126°
        angle = 90 + ((bmi - 25) / (30 - 25)) * 36;
    } else {
        // Obese: 126° to 180°
        angle = 126 + Math.min((bmi - 30) / 10, 1) * 54;
    }
    
    needle.style.transform = `translateX(-50%) rotate(${angle}deg)`;
}

// Calculate BMI instantly without form submission
function calculateInstant() {
    const weight = parseFloat(document.getElementById('weight').value);
    const height = parseFloat(document.getElementById('height').value);
    const weightUnit = document.getElementById('weightUnit').value;
    const heightUnit = document.getElementById('heightUnit').value;
    
    if (!weight || !height) {
        alert('Please enter both weight and height values.');
        return;
    }
    
    // Convert to metric if needed
    let weightKg = weight;
    let heightM = height;
    
    if (weightUnit === 'lbs') {
        weightKg = weight * 0.453592;
    }
    
    if (heightUnit === 'ft') {
        heightM = height * 30.48; // feet to cm
    }
    
    heightM = heightM / 100; // cm to meters
    
    const bmi = weightKg / (heightM * heightM);
    
    // Update display
    const resultDiv = document.getElementById('bmiResult');
    let category = '';
    let colorClass = '';
    
    if (bmi < 18.5) {
        category = 'Underweight';
        colorClass = 'text-primary';
    } else if (bmi < 25) {
        category = 'Normal Weight';
        colorClass = 'text-success';
    } else if (bmi < 30) {
        category = 'Overweight';
        colorClass = 'text-warning';
    } else {
        category = 'Obese';
        colorClass = 'text-danger';
    }
    
    resultDiv.innerHTML = `
        <h2 class="${colorClass}">${bmi.toFixed(1)}</h2>
        <h5 class="${colorClass}">${category}</h5>
    `;
    
    // Update needle
    updateBMINeedle(bmi);
}

// Auto-calculate on input change
document.addEventListener('DOMContentLoaded', function() {
    const inputs = ['weight', 'height', 'weightUnit', 'heightUnit'];
    inputs.forEach(id => {
        const element = document.getElementById(id);
        element.addEventListener('input', calculateInstant);
        element.addEventListener('change', calculateInstant);
    });
    
    // Set initial needle position if BMI exists
    {% if bmi %}
        updateBMINeedle({{ bmi }});
    {% endif %}
});

// Save BMI record
function saveBMIRecord() {
    const weight = document.getElementById('weight').value;
    const height = document.getElementById('height').value;
    const age = document.getElementById('age').value;
    const gender = document.getElementById('gender').value;
    
    if (!weight || !height || !age || !gender) {
        alert('Please fill in all fields before saving.');
        return;
    }
    
    // In a real app, this would save to the backend
    const bmiData = {
        weight: weight,
        height: height,
        age: age,
        gender: gender,
        bmi: document.querySelector('#bmiResult h2').textContent,
        category: document.querySelector('#bmiResult h5').textContent,
        date: new Date().toISOString()
    };
    
    // Save to localStorage as demo
    let bmiHistory = JSON.parse(localStorage.getItem('bmiHistory') || '[]');
    bmiHistory.push(bmiData);
    localStorage.setItem('bmiHistory', JSON.stringify(bmiHistory));
    
    alert('BMI record saved successfully!');
}

// Unit conversion helpers
document.getElementById('weightUnit').addEventListener('change', function() {
    const weightInput = document.getElementById('weight');
    const currentValue = parseFloat(weightInput.value);
    
    if (currentValue && this.value === 'lbs' && this.dataset.previous === 'kg') {
        weightInput.value = (currentValue * 2.20462).toFixed(1);
    } else if (currentValue && this.value === 'kg' && this.dataset.previous === 'lbs') {
        weightInput.value = (currentValue * 0.453592).toFixed(1);
    }
    
    this.dataset.previous = this.value;
    calculateInstant();
});

document.getElementById('heightUnit').addEventListener('change', function() {
    const heightInput = document.getElementById('height');
    const currentValue = parseFloat(heightInput.value);
    
    if (currentValue && this.value === 'ft' && this.dataset.previous === 'cm') {
        heightInput.value = (currentValue * 0.0328084).toFixed(1);
    } else if (currentValue && this.value === 'cm' && this.dataset.previous === 'ft') {
        heightInput.value = (currentValue * 30.48).toFixed(0);
    }
    
    this.dataset.previous = this.value;
    calculateInstant();
});

// Initialize unit tracking
document.getElementById('weightUnit').dataset.previous = 'kg';
document.getElementById('heightUnit').dataset.previous = 'cm';
</script>
{% endblock %}
